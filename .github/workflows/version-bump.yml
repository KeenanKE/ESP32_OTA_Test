name: Version Bump

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Get current version
      id: current_version
      run: |
        VERSION=$(grep 'FIRMWARE_VERSION' platformio.ini | sed 's/.*"\(.*\)"/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"
    
    - name: Bump version
      id: bump_version
      run: |
        CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped version: $CURRENT_VERSION â†’ $NEW_VERSION"
    
    - name: Update platformio.ini
      run: |
        NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
        sed -i "s/FIRMWARE_VERSION=\".*\"/FIRMWARE_VERSION=\"$NEW_VERSION\"/" platformio.ini
        
        echo "âœ… Updated platformio.ini to version $NEW_VERSION"
    
    - name: Check if version already bumped
      id: check_commit
      run: |
        git fetch origin ${{ github.head_ref }}
        if git log --oneline -1 | grep -q "chore: bump version"; then
          echo "already_bumped=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  Version already bumped in latest commit"
        else
          echo "already_bumped=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit version bump
      if: steps.check_commit.outputs.already_bumped == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add platformio.ini
        git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"
        git push origin ${{ github.head_ref }}
        
        echo "âœ… Version bumped and committed to PR branch"
    
    - name: Add PR comment
      if: steps.check_commit.outputs.already_bumped == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `### ðŸ”„ Version Bumped\n\n` +
                  `**Previous version:** \`${{ steps.current_version.outputs.version }}\`\n` +
                  `**New version:** \`${{ steps.bump_version.outputs.new_version }}\`\n\n` +
                  `The version has been automatically incremented and committed to this PR.`
          })
    
    - name: Summary
      run: |
        echo "### ðŸ”„ Version Bump Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Previous version:** ${{ steps.current_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **New version:** ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** Committed to PR branch" >> $GITHUB_STEP_SUMMARY
