name: Deploy OTA

on:
  release:
    types: [ published ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.3)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
    
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Deploying version: $VERSION"
    
    - name: Download release artifact
      if: github.event_name == 'release'
      run: |
        # Download firmware.bin from the release
        gh release download v${{ steps.version.outputs.version }} \
          --pattern "firmware.bin" \
          --dir ./temp_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build firmware for manual deployment
      if: github.event_name == 'workflow_dispatch'
      run: |
        # Set up Python and PlatformIO
        python -m pip install --upgrade pip
        pip install platformio
        
        # Create dummy .env file
        echo "WIFI_SSID=deploy_network" > .env
        echo "WIFI_PASSWORD=deploy_password" >> .env
        
        # Build firmware
        pio run
        
        # Copy to temp directory
        mkdir -p ./temp_release
        cp .pio/build/esp32doit-devkit-v1/firmware.bin ./temp_release/
    
    - name: Copy firmware to releases folder
      run: |
        mkdir -p releases
        cp ./temp_release/firmware.bin releases/firmware.bin
        
        # Update version.txt
        echo "${{ steps.version.outputs.version }}" > releases/version.txt
        
        echo "âœ… Copied firmware.bin and updated version.txt"
    
    - name: Commit and push to main
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add releases/firmware.bin releases/version.txt
        
        if git diff --staged --quiet; then
          echo "âš ï¸  No changes to commit"
        else
          git commit -m "deploy: OTA firmware v${{ steps.version.outputs.version }}"
          git push origin main
          echo "âœ… Deployed firmware to releases/ folder"
        fi
    
    - name: Verify deployment
      run: |
        echo "### âœ… OTA Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**OTA URLs:**" >> $GITHUB_STEP_SUMMARY
        echo "- Firmware: \`https://raw.githubusercontent.com/${{ github.repository }}/main/releases/firmware.bin\`" >> $GITHUB_STEP_SUMMARY
        echo "- Version: \`https://raw.githubusercontent.com/${{ github.repository }}/main/releases/version.txt\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ ESP32 devices will check for updates and download v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
